;A tool for timing video content. Times the two input frames and all frames in between.
;Calculates exact frames from approximate timestamps. Rounds times to exact frame values.
;Includes various other functionalities to time durations and remove loading or other unwanted time.
;
;Settings:
;SET-FPS: takes a number and sets it as the working FPS (default is 60)
;SET-OUT-FORMAT: takes either the string "seconds" or the string "frames" (default is "frames")
;CHECK-FPS: takes no inputs and returns the FPS the program is using to round and calculate frames
;CHECK-OUT-FORMAT: takes no inputs and returns the unit the program is calculating time in.
;
;Functions:
;FROM-TO: takes any two times in seconds, returns the duration between them.
;LOADLESS: takes a list of times in seconds of even length. Every other interval is added and returned. RTA time is printed.
;LONGFORM-FROM-TO: takes 2 lists of length 1 2 or 3 where the last element is seconds, the second to last is minutes and
;                  the third to last is hours. Calculates the difference between them.
;LONGFORM-LOADLESS: takes a list of lists like those described above.
;
;Example Inputs to Interpreter:
;(from-to 12.53 87.3)
;4487
;(loadless '(2.33 47.8 49.85 121.3 122.15 154.016))
;With Loads: 9102
;Loadless: 8930
;(longform-from-to '(1 34 25.55) '(1 35 1.33))
;2148
;(longform-loadless '((3 56.117) (5 12.533) (5 13.966) (7 45)))
;With Loads: 13734
;Loadless: 13649
;---------------------------------------------------------------------------------------------------------------------------

(define-struct settings (fps out-format))

;Booting with default settings
(define default-fps 60)
(define default-out-format "HH:MM:SS")
(define boot-settings (make-settings default-fps default-out-format))

;Settings
(define set-fps
  (lambda (fps)
    (cond
      ((> fps 0)
       (set-settings-fps! boot-settings fps))
      (#t
       (void)))))

(define set-out-format
  (lambda (out-format)
    (set-settings-out-format! boot-settings out-format)))

(define check-fps
  (lambda ()
    (settings-fps boot-settings)))

(define check-out-format
  (lambda ()
    (printf "The program will output time in terms of ~A." (settings-out-format boot-settings))))

;Timing functions
(define from-to
  (lambda (start stop)
    (format "~A" (format-converter (frame-counter start stop (settings-fps boot-settings))))))

(define loadless
  (lambda (listy)
    (cond
      ((even? (length listy))
       (format "With Loads: ~A Loadless: ~A" (from-to (first listy) (last listy))
               (format-converter (loadless-helper listy))))
      (#t
       (format "The list must have an even number of elements. See comments.")))))

(define longform-from-to
  (lambda (start stop)
    (from-to (longform-to-secs start) (longform-to-secs stop))))

(define longform-loadless
  (lambda (listy)
    (loadless (map longform-to-secs listy))))

(define longform-to-secs
  (lambda (listy)
    (cond
      ((= (length listy) 1)
       (first listy))
      ((= (length listy) 2)
       (+ (* (first listy) 60)
          (second listy)))
      (#t
       (+ (* (first listy) 3600)
          (* (second listy) 60)
          (last listy))))))

(define format-converter
  (lambda (frames)
    (cond
      ((equal? "seconds" (settings-out-format boot-settings))
       (exact->inexact(/ frames (settings-fps boot-settings))))
      ((equal? "seconds.frames" (settings-out-format boot-settings))
       (format "~A.~A"
               (floor (inexact->exact (/ frames (settings-fps boot-settings))))
               (inexact->exact(modulo frames (settings-fps boot-settings)))))
      ((equal? "HH:MM:SS" (settings-out-format boot-settings))
       (format "~A:~A:~A"
               (inexact->exact (floor (exact->inexact(/ frames (* (settings-fps boot-settings) 216000)))))
               (inexact->exact (modulo (floor (exact->inexact (/ frames (* (settings-fps boot-settings) 3600)))) 60))
               (+ (modulo (floor (exact->inexact(/ frames (settings-fps boot-settings)))) 60)
                 (- (exact->inexact(/ frames (settings-fps boot-settings)))
                    (floor (exact->inexact(/ frames (settings-fps boot-settings))))))))
      (#t
       (inexact->exact frames)))))

(define loadless-helper
  (lambda (listy)
    (cond
      ((= (length listy) 2)
       (frame-counter (first listy) (second listy) (settings-fps boot-settings)))
      (#t
       (+ (frame-counter (first listy) (second listy) (settings-fps boot-settings))
          (loadless-helper (rest (rest listy))))))))

(define frame-counter
  (lambda (start stop fps)
    (letrec ((sec-start (floor start))
             (frac-start (- start sec-start))
             (sec-stop (floor stop))
             (frac-stop (- stop sec-stop)))
      (+ (- (+ (* sec-stop fps) (frac-to-frame frac-stop fps))
            (+ (* sec-start fps) (frac-to-frame frac-start fps)))
         1))))

(define frac-to-frame
  (lambda (frac fps)
    (round (* frac fps))))